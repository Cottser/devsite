#!/usr/bin/env bash

function devsite() {
  # Check if CONFIG_PATH is writable. If it isn't, try to change it.
  if [ ! -w "$CONFIG_PATH" ]; then
    local CONFIG_READONLY=1
    chmod u+w "$CONFIG_PATH"
  fi

  write_settings_files "$@"
  write_drushrc "$@"
  create_db "$@"
  write_db_settings "$@"

  # @todo Add hosts file entry.
  # @todo Add VirtualHost entry.
  # @todo Restart Apache (ask for password up front)
}

# Write settings.local.php.
function write_settings_files() {
  # @todo Add back settings.php overwrite? So far it's just been annoying. It
  #   would be better if we just checked for settings.local.php being included
  #   in the settings file and appended if necessary.

  # Confirm overwrite of existing settings.local.php file.
  CONFIRM='y'
  if [ -e "$CONFIG_PATH/settings.local.php" ]; then
    yesno "Overwrite existing settings.local.php file?"
  fi
  [ "$CONFIRM" == 'y' ] && cp -f ~/Sites/default_files/drupal$DRUPAL_VERSION/settings.local.php $CONFIG_PATH
}

# Write a very basic drushrc.php so that things like `drush uli` just work.
function write_drushrc() {
  if [ ! -e "$CONFIG_PATH/drushrc.php" ]; then
    cat << __EOF > "$CONFIG_PATH/drushrc.php"
<?php

\$options['l'] = "http://$1";
__EOF
  fi
}

# Create the database if it doesn't yet exist.
function create_db() {
  # Remove the database details from the SQL connection details.
  local SQL_CONNECTION="$(echo $(drush sql-connect) | sed -E "s/--database=[^ ]+ //")"
  # Create the database if it doesn't exist.
  $($SQL_CONNECTION --execute="CREATE DATABASE IF NOT EXISTS $DB_NAME")
}

# Write the name of the database to settings.local.php.
function write_db_settings() {
  local TEMP_FILE="/tmp/devsite_$DB_NAME.tmp"
  sed "s/'database' => '_dev'/'database' => '$DB_NAME'/" < "$CONFIG_PATH/settings.local.php" > $TEMP_FILE &&
  cp $TEMP_FILE "$CONFIG_PATH/settings.local.php"
  rm $TEMP_FILE
}

# Utility function to create a yes/no prompt.
#
# Code inspired by http://ubuntuforums.org/showthread.php?t=436799
#
# Usage:
#   yesno "Would you like to do something?"
#   [ "$CONFIRM" == 'y' ] && echo 'They said yes'
function yesno() {
  while true
  do
    echo -n "$1 (y or n): "
    read CONFIRM
    case $CONFIRM in
      y|Y|yes|Yes|YES) CONFIRM='y'; break ;;
      n|N|no|No|NO) CONFIRM='n'; break ;;
      *) echo Please enter only y or n.
    esac
  done
}

# Main function.
#
# Checks number of arguments and provides help text.
#
# Performs other checks and creates some basic variables then calls devsite()
# to start making things happen.
main() {
  if [ "$#" -ne 1 ]; then
    echo "Quickly spin up a Drupal site."
    echo
    echo "Usage: devsite example.dev"
    echo
    echo "Run from the root of a Drupal site and specify the VirtualHost."
    echo
    echo "The VirtualHost is used to generate the database name as well, in the"
    echo "example above the database would be example_dev."
    return;
  fi;

  local DRUPAL_VERSION="$(drush php-eval 'echo drush_drupal_major_version();')"
  if [ ! $DRUPAL_VERSION ]; then
    echo "No Drupal installation found."
    return 1
  fi

  # Currently Drupal 6 and 7 are supported.
  if [ $DRUPAL_VERSION -lt 6 -o $DRUPAL_VERSION -gt 7 ]; then
    echo "Drupal $DRUPAL_VERSION is not supported."
    return 1
  fi

  local CONFIG_PATH="$(drush php-eval 'echo DRUPAL_ROOT . "/" . conf_path();')"

  # Generate a database name by replacing dots with underscores in the provided
  # VirtualHost.
  # @todo Check for valid first argument, for example it should not contain
  #   whitespace and needs to be able to be used as a VirtualHost.
  local DB_NAME="$(echo $1 | sed "s/\./_/g")"

  devsite "$@"
}

main "$@"
